# Code generated by skv2. DO NOT EDIT.



{{- $glooMeshMgmtServer := $.Values.glooMeshMgmtServer}}
---

{{- define "gloo-mesh-mgmt-server.deploymentSpec"}}

# Deployment manifest for gloo-mesh-mgmt-server

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: gloo-mesh-mgmt-server
  annotations:
    app.kubernetes.io/name: gloo-mesh-mgmt-server
  name: gloo-mesh-mgmt-server
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app: gloo-mesh-mgmt-server
  template:
    metadata:
      labels:
        app: gloo-mesh-mgmt-server
      annotations:
        app.kubernetes.io/name: gloo-mesh-mgmt-server
        prometheus.io/path: /metrics
        prometheus.io/port: "9091"
        prometheus.io/scrape: "true"
        sidecar.istio.io/inject: "false"
    spec:
      serviceAccountName: gloo-mesh-mgmt-server
      volumes:
      - name: license-keys
        secret:
          secretName: '{{ $.Values.licenseSecretName | default "license-keys" }}'
      containers:
{{- $glooMeshMgmtServer := $.Values.glooMeshMgmtServer }}
{{- $glooMeshMgmtServerImage := $glooMeshMgmtServer.image }}
      - name: gloo-mesh-mgmt-server
        image: {{ $glooMeshMgmtServerImage.registry }}/{{ $glooMeshMgmtServerImage.repository }}:{{ $glooMeshMgmtServerImage.tag }}
        imagePullPolicy: {{ $glooMeshMgmtServerImage.pullPolicy }}
        args:
        - run
        - --cluster={{ if (and $.Values.global $.Values.global.cluster) -}}{{ if $.Values.mgmtClusterName -}}{{ (eq $.Values.global.cluster "mgmt-cluster") | ternary $.Values.mgmtClusterName $.Values.global.cluster -}}{{ else -}}{{ $.Values.global.cluster -}}{{ end -}}{{ else -}}{{ $.Values.mgmtClusterName -}}{{ end }}
        - --admin-namespace={{ $.Values.adminNamespace | default $.Release.Namespace }}
        - --grpc-port={{ $.Values.glooMeshMgmtServer.ports.grpc }}
        - --stats-port={{ $.Values.glooMeshMgmtServer.statsPort }}
        - --dev-logger={{ $.Values.devMode }}
        - --relay-server-tls-secret-name={{ $.Values.glooMeshMgmtServer.relay.tlsSecret.name }}
        - --relay-server-tls-secret-namespace={{ $.Values.glooMeshMgmtServer.relay.tlsSecret.namespace | default $.Release.Namespace }}
        - --relay-tls-signing-secret-name={{ $.Values.glooMeshMgmtServer.relay.signingTlsSecret.name }}
        - --relay-tls-signing-secret-namespace={{ $.Values.glooMeshMgmtServer.relay.signingTlsSecret.namespace | default $.Release.Namespace }}
        - --relay-identity-token-secret-name={{ $.Values.glooMeshMgmtServer.relay.tokenSecret.name }}
        - --relay-identity-token-secret-namespace={{ $.Values.glooMeshMgmtServer.relay.tokenSecret.namespace | default $.Release.Namespace }}
        - --relay-identity-token-secret-key={{ $.Values.glooMeshMgmtServer.relay.tokenSecret.key }}
        - --disable-relay-ca={{ $.Values.glooMeshMgmtServer.relay.disableCa }}
        - --relay-push-rbac={{ $.Values.glooMeshMgmtServer.relay.pushRbac }}
        - --max-grpc-message-size={{ $.Values.glooMeshMgmtServer.maxGrpcMessageSize }}
        - --concurrency={{ $.Values.glooMeshMgmtServer.concurrency }}
        - --enable-cluster-load-balancing={{ $.Values.glooMeshMgmtServer.enableClusterLoadBalancing }}
        - --insecure={{ $.Values.insecure }}
        - --verbose={{ $.Values.verbose }}
        - --leader-election={{ $.Values.leaderElection }}
        - --http-healthcheck-port={{ $.Values.glooMeshMgmtServer.ports.healthcheck }}
        - --redis-address={{ $.Values.glooMeshRedis.addr | default (printf "gloo-mesh-redis.%s:6379" $.Release.Namespace )  }}
{{- if $glooMeshMgmtServer.env }}
        env:
{{ toYaml $glooMeshMgmtServer.env | indent 10 }}
{{- end }}
        volumeMounts:
        - mountPath: /etc/license-keys
          name: license-keys
          readOnly: true
        resources:
{{- if $glooMeshMgmtServer.resources }}
{{ toYaml $glooMeshMgmtServer.resources | indent 10}}
{{- else}}
          requests:
            cpu: 500m
            memory: 256Mi
{{- end}}
        {{- /*
          Render securityContext configs if it is set.
          If securityContext is not set, render the default securityContext.
          If securityContext is set to 'false', render an empty map.
        */}}
        securityContext:
{{- if or ($glooMeshMgmtServer.securityContext) (eq "map[]" (printf "%v" $glooMeshMgmtServer.securityContext)) }}
{{ toYaml $glooMeshMgmtServer.securityContext | indent 10}}
{{/* Because securityContext is nil by default we can only perform following conversion if it is a boolean. Skip conditional otherwise. */}}
{{- else if eq (ternary $glooMeshMgmtServer.securityContext true (eq "bool" (printf "%T" $glooMeshMgmtServer.securityContext))) false }}
          {}
{{- else}}
          runAsNonRoot: true
          {{- if not $glooMeshMgmtServer.floatingUserId }}
          runAsUser: {{ printf "%.0f" (float64 $glooMeshMgmtServer.runAsUser) }}
          {{- end }}
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
{{- end}}
      {{- if $glooMeshMgmtServerImage.pullSecret }}
      imagePullSecrets:
        - name: {{ $glooMeshMgmtServerImage.pullSecret }}
      {{- end}}
{{- end }} {{/* define "gloo-mesh-mgmt-server.deploymentSpec" */}}

{{/* Render gloo-mesh-mgmt-server deployment template with overrides from values*/}}
{{- if $glooMeshMgmtServer.enabled }}
{{- $glooMeshMgmtServerDeploymentOverrides := dict }}
{{- if $glooMeshMgmtServer.deploymentOverrides }}
{{- $glooMeshMgmtServerDeploymentOverrides = $glooMeshMgmtServer.deploymentOverrides  }}
{{- end }}
---
{{ include "skv2.utils.merge" (list . $glooMeshMgmtServerDeploymentOverrides "gloo-mesh-mgmt-server.deploymentSpec") }}
{{- end }}
---

{{- if $glooMeshMgmtServer.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: gloo-mesh-mgmt-server
  name: gloo-mesh-mgmt-server
  namespace: {{ $.Release.Namespace }}
{{- end }}


{{- define "gloo-mesh-mgmt-server.serviceSpec"}}

# Service for gloo-mesh-mgmt-server
{{/* Define variables in function scope */}}
{{- $glooMeshMgmtServer := $.Values.glooMeshMgmtServer}}
apiVersion: v1
kind: Service
metadata:
  labels:
    app: gloo-mesh-mgmt-server
  annotations:
    app.kubernetes.io/name: gloo-mesh-mgmt-server
    prometheus.io/path: /metrics
    prometheus.io/port: "9091"
    prometheus.io/scrape: "true"
  name: gloo-mesh-mgmt-server
  namespace: {{ $.Release.Namespace }}
spec:
  selector:
    app: gloo-mesh-mgmt-server
  type: {{ $glooMeshMgmtServer.serviceType }}
  ports:
  - name: healthcheck
    port: {{ $glooMeshMgmtServer.ports.healthcheck }}
  - name: grpc
    port: {{ $glooMeshMgmtServer.ports.grpc }}

{{- end }} {{/* define "gloo-mesh-mgmt-server.serviceSpec" */}}

{{- if $glooMeshMgmtServer.enabled }}
{{/* Render gloo-mesh-mgmt-server service template with overrides from values*/}}
{{- $glooMeshMgmtServerServiceOverrides := dict }}
{{- if $glooMeshMgmtServer.serviceOverrides }}
{{- $glooMeshMgmtServerServiceOverrides = $glooMeshMgmtServer.serviceOverrides  }}
{{- end }}

---

{{ include "skv2.utils.merge" (list . $glooMeshMgmtServerServiceOverrides "gloo-mesh-mgmt-server.serviceSpec") }}
{{- end }}

---



{{- $glooMeshUi := $.Values.glooMeshUi}}
---

{{- define "gloo-mesh-ui.deploymentSpec"}}

# Deployment manifest for gloo-mesh-ui

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: gloo-mesh-ui
    gloo-mesh: gloo-mesh-ui
  annotations:
    app.kubernetes.io/name: gloo-mesh-ui
  name: gloo-mesh-ui
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app: gloo-mesh-ui
      gloo-mesh: gloo-mesh-ui
  template:
    metadata:
      labels:
        app: gloo-mesh-ui
        gloo-mesh: gloo-mesh-ui
      annotations:
        app.kubernetes.io/name: gloo-mesh-ui
        prometheus.io/path: /metrics
        prometheus.io/port: "9091"
        prometheus.io/scrape: "true"
        sidecar.istio.io/inject: "false"
    spec:
      serviceAccountName: gloo-mesh-ui
      volumes:
      - name: license-keys
        secret:
          secretName: '{{ $.Values.licenseSecretName | default "license-keys" }}'
      - configMap:
          name: dashboard-envoy
        name: envoy-config
      - emptyDir: {}
        name: empty-cache
      - emptyDir: {}
        name: empty-run
      containers:
{{- $glooMeshUi := $.Values.glooMeshUi }}
{{- $glooMeshUiImage := $glooMeshUi.image }}
      - name: gloo-mesh-ui
        image: {{ $glooMeshUiImage.registry }}/{{ $glooMeshUiImage.repository }}:{{ $glooMeshUiImage.tag }}
        imagePullPolicy: {{ $glooMeshUiImage.pullPolicy }}
        args:
        - --cluster={{ if (and $.Values.global $.Values.global.cluster) -}}{{ if $.Values.mgmtClusterName -}}{{ (eq $.Values.global.cluster "mgmt-cluster") | ternary $.Values.mgmtClusterName $.Values.global.cluster -}}{{ else -}}{{ $.Values.global.cluster -}}{{ end -}}{{ else -}}{{ $.Values.mgmtClusterName -}}{{ end }}
        - --grpc-port={{ $.Values.glooMeshUi.ports.grpc }}
        - --health-check-port={{ $.Values.glooMeshUi.ports.healthcheck }}
        - --prometheus-url={{ $.Values.prometheusUrl }}
        - --redis-address={{ $.Values.glooMeshRedis.addr | default (printf "gloo-mesh-redis.%s:6379" $.Release.Namespace )  }}
{{- if $glooMeshUi.env }}
        env:
{{ toYaml $glooMeshUi.env | indent 10 }}
{{- end }}
        volumeMounts:
        - mountPath: /etc/license-keys
          name: license-keys
          readOnly: true
        resources:
{{- if $glooMeshUi.resources }}
{{ toYaml $glooMeshUi.resources | indent 10}}
{{- else}}
          requests:
            cpu: 500m
            memory: 256Mi
{{- end}}
        {{- /*
          Render securityContext configs if it is set.
          If securityContext is not set, render the default securityContext.
          If securityContext is set to 'false', render an empty map.
        */}}
        securityContext:
{{- if or ($glooMeshUi.securityContext) (eq "map[]" (printf "%v" $glooMeshUi.securityContext)) }}
{{ toYaml $glooMeshUi.securityContext | indent 10}}
{{/* Because securityContext is nil by default we can only perform following conversion if it is a boolean. Skip conditional otherwise. */}}
{{- else if eq (ternary $glooMeshUi.securityContext true (eq "bool" (printf "%T" $glooMeshUi.securityContext))) false }}
          {}
{{- else}}
          runAsNonRoot: true
          {{- if not $glooMeshUi.floatingUserId }}
          runAsUser: {{ printf "%.0f" (float64 $glooMeshUi.runAsUser) }}
          {{- end }}
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
{{- end}}
        readinessProbe:
          httpGet:
            path: /
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
{{- $envoy := $.Values.glooMeshUi.sidecars.envoy }}
{{- $envoyImage := $envoy.image }}
      - name: envoy
        image: {{ $envoyImage.registry }}/{{ $envoyImage.repository }}:{{ $envoyImage.tag }}
        imagePullPolicy: {{ $envoyImage.pullPolicy }}
{{- if $envoy.env }}
        env:
{{ toYaml $envoy.env | indent 10 }}
{{- end }}
        volumeMounts:
        - mountPath: /etc/envoy
          name: envoy-config
          readOnly: true
        resources:
{{- if $envoy.resources }}
{{ toYaml $envoy.resources | indent 10}}
{{- else}}
          requests:
            cpu: 500m
            memory: 256Mi
{{- end}}
        {{- /*
          Render securityContext configs if it is set.
          If securityContext is not set, render the default securityContext.
          If securityContext is set to 'false', render an empty map.
        */}}
        securityContext:
{{- if or ($envoy.securityContext) (eq "map[]" (printf "%v" $envoy.securityContext)) }}
{{ toYaml $envoy.securityContext | indent 10}}
{{/* Because securityContext is nil by default we can only perform following conversion if it is a boolean. Skip conditional otherwise. */}}
{{- else if eq (ternary $envoy.securityContext true (eq "bool" (printf "%T" $envoy.securityContext))) false }}
          {}
{{- else}}
          runAsNonRoot: true
          {{- if not $glooMeshUi.floatingUserId }}
          runAsUser: {{ printf "%.0f" (float64 $glooMeshUi.runAsUser) }}
          {{- end }}
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
{{- end}}
        readinessProbe:
          httpGet:
            path: /
            port: 20202
          initialDelaySeconds: 5
          periodSeconds: 10
{{- $console := $.Values.glooMeshUi.sidecars.console }}
{{- $consoleImage := $console.image }}
      - name: console
        image: {{ $consoleImage.registry }}/{{ $consoleImage.repository }}:{{ $consoleImage.tag }}
        imagePullPolicy: {{ $consoleImage.pullPolicy }}
{{- if $console.env }}
        env:
{{ toYaml $console.env | indent 10 }}
{{- end }}
        volumeMounts:
        - mountPath: /var/cache/nginx
          name: empty-cache
        - mountPath: /var/run
          name: empty-run
        resources:
{{- if $console.resources }}
{{ toYaml $console.resources | indent 10}}
{{- else}}
          requests:
            cpu: 500m
            memory: 256Mi
{{- end}}
        {{- /*
          Render securityContext configs if it is set.
          If securityContext is not set, render the default securityContext.
          If securityContext is set to 'false', render an empty map.
        */}}
        securityContext:
{{- if or ($console.securityContext) (eq "map[]" (printf "%v" $console.securityContext)) }}
{{ toYaml $console.securityContext | indent 10}}
{{/* Because securityContext is nil by default we can only perform following conversion if it is a boolean. Skip conditional otherwise. */}}
{{- else if eq (ternary $console.securityContext true (eq "bool" (printf "%T" $console.securityContext))) false }}
          {}
{{- else}}
          runAsNonRoot: true
          {{- if not $glooMeshUi.floatingUserId }}
          runAsUser: {{ printf "%.0f" (float64 $glooMeshUi.runAsUser) }}
          {{- end }}
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
{{- end}}
        readinessProbe:
          httpGet:
            path: /
            port: 8090
          initialDelaySeconds: 5
          periodSeconds: 10
      {{- if $glooMeshUiImage.pullSecret }}
      imagePullSecrets:
        - name: {{ $glooMeshUiImage.pullSecret }}
      {{- end}}
{{- end }} {{/* define "gloo-mesh-ui.deploymentSpec" */}}

{{/* Render gloo-mesh-ui deployment template with overrides from values*/}}
{{- if $glooMeshUi.enabled }}
{{- $glooMeshUiDeploymentOverrides := dict }}
{{- if $glooMeshUi.deploymentOverrides }}
{{- $glooMeshUiDeploymentOverrides = $glooMeshUi.deploymentOverrides  }}
{{- end }}
---
{{ include "skv2.utils.merge" (list . $glooMeshUiDeploymentOverrides "gloo-mesh-ui.deploymentSpec") }}
{{- end }}
---

{{- if $glooMeshUi.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: gloo-mesh-ui
  name: gloo-mesh-ui
  namespace: {{ $.Release.Namespace }}
{{- end }}


{{- define "gloo-mesh-ui.serviceSpec"}}

# Service for gloo-mesh-ui
{{/* Define variables in function scope */}}
{{- $glooMeshUi := $.Values.glooMeshUi}}
apiVersion: v1
kind: Service
metadata:
  labels:
    app: gloo-mesh-ui
  annotations:
    app.kubernetes.io/name: gloo-mesh-ui
  name: gloo-mesh-ui
  namespace: {{ $.Release.Namespace }}
spec:
  selector:
    app: gloo-mesh-ui
  type: {{ $glooMeshUi.serviceType }}
  ports:
  - name: grpc
    port: {{ $glooMeshUi.ports.grpc }}
  - name: console
    port: {{ $glooMeshUi.ports.console }}
  - name: healthcheck
    port: {{ $glooMeshUi.ports.healthcheck }}

{{- end }} {{/* define "gloo-mesh-ui.serviceSpec" */}}

{{- if $glooMeshUi.enabled }}
{{/* Render gloo-mesh-ui service template with overrides from values*/}}
{{- $glooMeshUiServiceOverrides := dict }}
{{- if $glooMeshUi.serviceOverrides }}
{{- $glooMeshUiServiceOverrides = $glooMeshUi.serviceOverrides  }}
{{- end }}

---

{{ include "skv2.utils.merge" (list . $glooMeshUiServiceOverrides "gloo-mesh-ui.serviceSpec") }}
{{- end }}

---



{{- $glooMeshRedis := $.Values.glooMeshRedis}}
---

{{- define "gloo-mesh-redis.deploymentSpec"}}

# Deployment manifest for gloo-mesh-redis

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: gloo-mesh-redis
    gloo-mesh: gloo-mesh-redis
  annotations:
    app.kubernetes.io/name: gloo-mesh-redis
  name: gloo-mesh-redis
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app: gloo-mesh-redis
      gloo-mesh: gloo-mesh-redis
  template:
    metadata:
      labels:
        app: gloo-mesh-redis
        gloo-mesh: gloo-mesh-redis
      annotations:
        app.kubernetes.io/name: gloo-mesh-redis
        prometheus.io/path: /metrics
        prometheus.io/port: "9091"
        prometheus.io/scrape: "true"
    spec:
      serviceAccountName: gloo-mesh-redis
      volumes:
      - emptyDir: {}
        name: data
      containers:
{{- $glooMeshRedis := $.Values.glooMeshRedis }}
{{- $glooMeshRedisImage := $glooMeshRedis.image }}
      - name: gloo-mesh-redis
        image: {{ $glooMeshRedisImage.registry }}/{{ $glooMeshRedisImage.repository }}:{{ $glooMeshRedisImage.tag }}
        imagePullPolicy: {{ $glooMeshRedisImage.pullPolicy }}
        args:
        - --save ""
        - --appendonly no
{{- if $glooMeshRedis.env }}
        env:
{{ toYaml $glooMeshRedis.env | indent 10 }}
{{- end }}
        volumeMounts:
        - mountPath: /redis-master-data
          name: data
        resources:
{{- if $glooMeshRedis.resources }}
{{ toYaml $glooMeshRedis.resources | indent 10}}
{{- else}}
          requests:
            cpu: 500m
            memory: 256Mi
{{- end}}
        {{- /*
          Render securityContext configs if it is set.
          If securityContext is not set, render the default securityContext.
          If securityContext is set to 'false', render an empty map.
        */}}
        securityContext:
{{- if or ($glooMeshRedis.securityContext) (eq "map[]" (printf "%v" $glooMeshRedis.securityContext)) }}
{{ toYaml $glooMeshRedis.securityContext | indent 10}}
{{/* Because securityContext is nil by default we can only perform following conversion if it is a boolean. Skip conditional otherwise. */}}
{{- else if eq (ternary $glooMeshRedis.securityContext true (eq "bool" (printf "%T" $glooMeshRedis.securityContext))) false }}
          {}
{{- else}}
          runAsNonRoot: true
          {{- if not $glooMeshRedis.floatingUserId }}
          runAsUser: {{ printf "%.0f" (float64 $glooMeshRedis.runAsUser) }}
          {{- end }}
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
{{- end}}
      {{- if $glooMeshRedisImage.pullSecret }}
      imagePullSecrets:
        - name: {{ $glooMeshRedisImage.pullSecret }}
      {{- end}}
{{- end }} {{/* define "gloo-mesh-redis.deploymentSpec" */}}

{{/* Render gloo-mesh-redis deployment template with overrides from values*/}}
{{- if $glooMeshRedis.enabled }}
{{- $glooMeshRedisDeploymentOverrides := dict }}
{{- if $glooMeshRedis.deploymentOverrides }}
{{- $glooMeshRedisDeploymentOverrides = $glooMeshRedis.deploymentOverrides  }}
{{- end }}
---
{{ include "skv2.utils.merge" (list . $glooMeshRedisDeploymentOverrides "gloo-mesh-redis.deploymentSpec") }}
{{- end }}
---

{{- if $glooMeshRedis.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: gloo-mesh-redis
  name: gloo-mesh-redis
  namespace: {{ $.Release.Namespace }}
{{- end }}


{{- define "gloo-mesh-redis.serviceSpec"}}

# Service for gloo-mesh-redis
{{/* Define variables in function scope */}}
{{- $glooMeshRedis := $.Values.glooMeshRedis}}
apiVersion: v1
kind: Service
metadata:
  labels:
    app: gloo-mesh-redis
  annotations:
    app.kubernetes.io/name: gloo-mesh-redis
  name: gloo-mesh-redis
  namespace: {{ $.Release.Namespace }}
spec:
  selector:
    app: gloo-mesh-redis
  type: {{ $glooMeshRedis.serviceType }}
  ports:
  - name: redis
    port: {{ $glooMeshRedis.ports.redis }}

{{- end }} {{/* define "gloo-mesh-redis.serviceSpec" */}}

{{- if $glooMeshRedis.enabled }}
{{/* Render gloo-mesh-redis service template with overrides from values*/}}
{{- $glooMeshRedisServiceOverrides := dict }}
{{- if $glooMeshRedis.serviceOverrides }}
{{- $glooMeshRedisServiceOverrides = $glooMeshRedis.serviceOverrides  }}
{{- end }}

---

{{ include "skv2.utils.merge" (list . $glooMeshRedisServiceOverrides "gloo-mesh-redis.serviceSpec") }}
{{- end }}

---

